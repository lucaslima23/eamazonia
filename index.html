<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --white: #ffffff; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        /* Utilitarios */
        .hidden { display: none !important; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 13px; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: #ef4444; }
        .btn-warning { background: #f59e0b; }
        .btn-success { background: #10b981; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: var(--white); padding: 2rem; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;}

        /* Dashboard */
        #dashboard-screen { width: 100%; display: flex; }
        .sidebar { width: 250px; background: var(--white); padding: 20px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Tabela */
        table { width: 100%; border-collapse: collapse; background: var(--white); margin-top: 20px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge.Pendente { background: #fee2e2; color: #991b1b; }
        .badge.Em { background: #fef3c7; color: #92400e; } /* Em Andamento/Revisao */
        .badge.Aprovado { background: #d1fae5; color: #065f46; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .actions-row { display: flex; gap: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary);">Gest√£o Pro</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="senha" placeholder="Senha">
            <button class="btn btn-primary" style="width:100%" onclick="fazerLogin()">ACESSAR</button>
            <p id="msg-erro" style="color: red; font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div class="sidebar">
            <h2>Menu</h2>
            <p id="user-info" style="font-size: 12px; color: #666; margin-bottom: 20px;"></p>
            <div style="margin-top: auto; cursor: pointer; color: red;" onclick="logout()">Sair</div>
        </div>
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Tarefas</h1>
                <button id="btn-nova-tarefa" class="btn btn-success hidden" onclick="abrirModalCriacao()">+ Nova Tarefa</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="tabela-tarefas">
                    <thead>
                        <tr>
                            <th>Tarefa</th>
                            <th>Respons√°vel</th>
                            <th>Prazo</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-tarefa" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-titulo">Editar Tarefa</h3>
            <input type="hidden" id="task-id">
            
            <div class="form-group" id="group-titulo">
                <label>T√≠tulo da Tarefa</label>
                <input type="text" id="task-title">
            </div>

            <div class="form-group" id="group-projeto">
                <label>Projeto</label>
                <select id="task-project"></select>
            </div>

            <div class="form-group" id="group-responsavel">
                <label>Respons√°vel</label>
                <select id="task-resp" disabled></select> </div>

            <div class="form-group">
                <label>Status</label>
                <select id="task-status">
                    <option value="Pendente">Pendente</option>
                    <option value="Em Andamento">Em Andamento</option>
                    <option value="Em Revis√£o">Em Revis√£o</option>
                    <option value="Aprovado">Aprovado</option>
                </select>
            </div>

            <div class="form-group" id="group-prazo">
                <label>Prazo Final</label>
                <input type="date" id="task-prazo">
            </div>

            <div class="form-group">
                <label>Anexar Arquivo (Link Google Drive ser√° gerado)</label>
                <input type="file" id="task-file">
                <small id="current-link-display" style="display:block; margin-top:5px; color:#2563eb;"></small>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-danger" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarTarefa()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyY9lABJwES9TnZjuhw--URDOZj5-mpsMctrjvh1x3tc8kM-PtLylB85Jly19GKqDM/exec"; // <--- COLE SUA URL NOVA AQUI

        let DADOS_GLOBAIS = {}; // Armazena projetos e colaboradores carregados

        function fazerLogin() {
            const email = document.getElementById("email").value;
            const senha = document.getElementById("senha").value;
            const btn = document.querySelector("#login-screen button");
            
            btn.innerText = "Carregando...";
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "login", email, senha }) })
            .then(r => r.json())
            .then(data => {
                if (data.status === "sucesso") {
                    localStorage.setItem("user", JSON.stringify(data.usuario));
                    iniciarApp(data.usuario);
                } else {
                    document.getElementById("msg-erro").innerText = data.mensagem;
                    btn.innerText = "ACESSAR";
                }
            });
        }

        function iniciarApp(usuario) {
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("dashboard-screen").classList.remove("hidden");
            document.getElementById("user-info").innerHTML = `<b>${usuario.nome}</b><br>${usuario.funcao}`;
            
            // Mostrar bot√£o de criar apenas se for Gestor
            if(usuario.funcao === "Gestor") {
                document.getElementById("btn-nova-tarefa").classList.remove("hidden");
                document.getElementById("task-resp").disabled = false; // Gestor pode mudar respons√°vel
            }

            carregarDados();
        }

        function carregarDados() {
            const user = JSON.parse(localStorage.getItem("user"));
            
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getDados", usuarioEmail: user.email }) })
            .then(r => r.json())
            .then(data => {
                DADOS_GLOBAIS = data;
                renderizarTabela(data.todasTarefas, user);
                preencherDropdowns();
            });
        }

        function renderizarTabela(tarefas, user) {
            const tbody = document.querySelector("tbody");
            tbody.innerHTML = "";
            
            // Filtro: Se for Gestor v√™ tudo, se n√£o, v√™ apenas as suas
            const tarefasVisiveis = user.funcao === "Gestor" ? tarefas : tarefas.filter(t => t.Responsavel_Email === user.email || t.Revisor_Email === user.email);

            tarefasVisiveis.forEach(t => {
                let botoes = `<button class="btn btn-primary" onclick='abrirModalEdicao(${JSON.stringify(t)})'>Editar</button>`;
                
                // Bot√µes extras para Gestor
                if (user.funcao === "Gestor") {
                    botoes += ` <button class="btn btn-warning" onclick="enviarLembrete('${t.ID_Atividade}')">üîî</button>`;
                    botoes += ` <button class="btn btn-danger" onclick="excluirTarefa('${t.ID_Atividade}')">üóëÔ∏è</button>`;
                }

                const row = `<tr>
                    <td>${t.Nome_Subetapa}</td>
                    <td>${t.Responsavel_Email}</td>
                    <td>${new Date(t.Prazo_Final).toLocaleDateString()}</td>
                    <td><span class="badge ${t.Status.split(' ')[0]}">${t.Status}</span></td>
                    <td class="actions-row">${botoes}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- L√ìGICA DO MODAL ---

        function preencherDropdowns() {
            const projSelect = document.getElementById("task-project");
            const respSelect = document.getElementById("task-resp");
            
            projSelect.innerHTML = DADOS_GLOBAIS.projetos.map(p => `<option value="${p.ID_Projeto}">${p.Nome_Do_Projeto}</option>`).join('');
            respSelect.innerHTML = DADOS_GLOBAIS.colaboradores.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function abrirModalCriacao() {
            document.getElementById("modal-tarefa").classList.remove("hidden");
            document.getElementById("modal-titulo").innerText = "Nova Tarefa";
            document.getElementById("task-id").value = "new";
            document.getElementById("task-title").value = "";
            document.getElementById("current-link-display").innerText = "";
            // Mostra campos de cria√ß√£o que podem estar ocultos na edi√ß√£o
            document.getElementById("group-titulo").classList.remove("hidden"); 
        }

        function abrirModalEdicao(tarefa) {
            document.getElementById("modal-tarefa").classList.remove("hidden");
            document.getElementById("modal-titulo").innerText = "Editar Tarefa";
            document.getElementById("task-id").value = tarefa.ID_Atividade;
            document.getElementById("task-title").value = tarefa.Nome_Subetapa;
            document.getElementById("task-status").value = tarefa.Status;
            document.getElementById("task-resp").value = tarefa.Responsavel_Email;
            
            // Se j√° tem link
            const linkDisplay = document.getElementById("current-link-display");
            linkDisplay.innerHTML = tarefa.Arquivo_Entregue ? `<a href="${tarefa.Arquivo_Entregue}" target="_blank">Ver Arquivo Atual</a>` : "";
        }

        function fecharModal() {
            document.getElementById("modal-tarefa").classList.add("hidden");
        }

        async function salvarTarefa() {
            const id = document.getElementById("task-id").value;
            const fileInput = document.getElementById("task-file");
            const btn = document.querySelector("#modal-tarefa .btn-primary");
            
            let payload = {
                action: "salvarTarefa",
                id: id,
                status: document.getElementById("task-status").value,
                responsavel: document.getElementById("task-resp").value,
                // Campos usados apenas na cria√ß√£o
                titulo: document.getElementById("task-title").value,
                projetoId: document.getElementById("task-project").value,
                prazo: document.getElementById("task-prazo").value
            };

            btn.innerText = "Salvando...";
            btn.disabled = true;

            // Se tiver arquivo, faz upload primeiro
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const base64 = await toBase64(file);
                
                const uploadRes = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "uploadArquivo",
                        nomeArquivo: file.name,
                        tipoMime: file.type,
                        arquivoBase64: base64
                    })
                }).then(r => r.json());

                if(uploadRes.status === "sucesso") {
                    payload.link = uploadRes.link;
                } else {
                    alert("Erro ao subir arquivo");
                    btn.disabled = false;
                    return;
                }
            }

            // Salva os dados da tarefa
            fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(r => r.json())
            .then(data => {
                alert(data.mensagem);
                fecharModal();
                carregarDados(); // Recarrega a tabela
                btn.innerText = "Salvar";
                btn.disabled = false;
            });
        }

        function excluirTarefa(id) {
            if(!confirm("Tem certeza que deseja excluir?")) return;
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "excluirTarefa", id }) })
            .then(() => carregarDados());
        }

        function enviarLembrete(id) {
            alert("Lembrete enviado!"); // Feedback visual imediato
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "enviarLembrete", id }) });
        }

        function logout() { localStorage.clear(); location.reload(); }
        
        // Helper para ler arquivo
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        // Auto-login
        window.onload = function() {
            const user = JSON.parse(localStorage.getItem("user"));
            if (user) iniciarApp(user);
        };
    </script>
</body>
</html>
